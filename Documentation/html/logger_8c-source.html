<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>/home/noxon/coding/C/esiee-in301/libcomm/logger.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.5 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>/home/noxon/coding/C/esiee-in301/libcomm/logger.c</h1><a href="logger_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "<a class="code" href="logger_8h.html">logger.h</a>"</span>
<a name="l00002"></a>00002 
<a name="l00003"></a><a class="code" href="logger_8c.html#eac90097f29f7529968697163cea5c18">00003</a> <span class="keywordtype">char</span> *<a class="code" href="logger_8c.html#eac90097f29f7529968697163cea5c18">filename</a>= NULL;
<a name="l00004"></a>00004 
<a name="l00005"></a><a class="code" href="logger_8h.html#d2002666dc679ddab3032057c21c1305">00005</a> <span class="keywordtype">int</span> <a class="code" href="logger_8c.html#cc125d9a55592a92f10fc818de33c089">init_log</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fn) {
<a name="l00006"></a>00006         FILE *fp = fopen(fn, <span class="stringliteral">"a+"</span>);
<a name="l00007"></a>00007         <span class="keywordflow">if</span> (fp== NULL)
<a name="l00008"></a>00008                 <span class="keywordflow">return</span> 0; <span class="comment">// échec</span>
<a name="l00009"></a>00009         fclose(fp);
<a name="l00010"></a>00010         <a class="code" href="logger_8c.html#eac90097f29f7529968697163cea5c18">filename</a> =( <span class="keywordtype">char</span>*)malloc( strlen(fn + 1) );
<a name="l00011"></a>00011         strcpy(<a class="code" href="logger_8c.html#eac90097f29f7529968697163cea5c18">filename</a>, fn);
<a name="l00012"></a>00012         <span class="keywordflow">return</span> 1; <span class="comment">// succès</span>
<a name="l00013"></a>00013 }
<a name="l00014"></a>00014 
<a name="l00015"></a><a class="code" href="logger_8h.html#5d4e11dc9c0756733a61a76f3e7f57b1">00015</a> <span class="keywordtype">void</span> <a class="code" href="logger_8c.html#5d4e11dc9c0756733a61a76f3e7f57b1">log_call</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmsg__struct.html">msg</a>, <span class="keywordtype">char</span> *func_name, <span class="keyword">const</span> <span class="keywordtype">char</span> *args, ...) {
<a name="l00016"></a>00016         <span class="keywordtype">char</span> fctNargs[1024] = { 0 };
<a name="l00017"></a>00017         sprintf(fctNargs, <span class="stringliteral">"%s%s"</span>, func_name, args); <span class="comment">// concaténation</span>
<a name="l00018"></a>00018         va_list arglist; <span class="comment">// nouveau struct qui va contenir les arguments</span>
<a name="l00019"></a>00019         va_start(arglist, args);
<a name="l00020"></a>00020         <span class="comment">// extraction des arguments et/ou de leur type</span>
<a name="l00021"></a>00021         <a class="code" href="logger_8c.html#a7017b21f46168c4c60cfe08a5dba154">private_log_call</a>(msg, fctNargs, arglist);
<a name="l00022"></a>00022         va_end(arglist);
<a name="l00023"></a>00023 }
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="logger_8h.html#6cc4eb379baec30531bd4852517f31ad">00026</a> <span class="keywordtype">void</span> <a class="code" href="logger_8c.html#6cc4eb379baec30531bd4852517f31ad">log_smth</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmsg__struct.html">msg</a>, ...) {
<a name="l00027"></a>00027         <span class="keywordtype">char</span> vspft[1024] = { 0 }, new_msg[1024] = { 0 };
<a name="l00028"></a>00028         va_list arglist; <span class="comment">// nouveau struct qui va contenir les arguments</span>
<a name="l00029"></a>00029         va_start(arglist, msg);
<a name="l00030"></a>00030         vsprintf(vspft, msg, arglist);
<a name="l00031"></a>00031         sprintf(new_msg, vspft, msg);
<a name="l00032"></a>00032         <a class="code" href="logger_8c.html#c5780f57248a4e80eb50e695b593a1a0">private_write_log</a>(<a class="code" href="logger_8h.html#26a2ec2574e71d699a30a6da87a9060aca3babe946c0278ce012de560a45db77">unkown_type</a>, new_msg);
<a name="l00033"></a>00033 }
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">// début des fonctions/méthodes non détaillées dans l'API</span>
<a name="l00036"></a>00036 <span class="comment">// elles ne sont pas dans l'API pour ne pas chargée cette dernière de fonctions réservées au code interne</span>
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="logger_8h.html#a7017b21f46168c4c60cfe08a5dba154">00038</a> <span class="keywordtype">void</span> <a class="code" href="logger_8c.html#a7017b21f46168c4c60cfe08a5dba154">private_log_call</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmsg__struct.html">msg</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *func_name, va_list args) {
<a name="l00039"></a>00039         <span class="keywordtype">char</span> vspft[1024] = { 0 }, new_msg[1024] = { 0 };
<a name="l00040"></a>00040         vsprintf(vspft, func_name, args); <span class="comment">// détermine le type de variable et l'affiche</span>
<a name="l00041"></a>00041         sprintf(new_msg, <span class="stringliteral">"%s %s"</span>, vspft, msg);
<a name="l00042"></a>00042         <a class="code" href="logger_8c.html#c5780f57248a4e80eb50e695b593a1a0">private_write_log</a>(<a class="code" href="logger_8h.html#26a2ec2574e71d699a30a6da87a9060aee067308743486de1676fa06a8b42e31">call_type</a>, new_msg);
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="logger_8h.html#c5780f57248a4e80eb50e695b593a1a0">00045</a> <span class="keywordtype">void</span> <a class="code" href="logger_8c.html#c5780f57248a4e80eb50e695b593a1a0">private_write_log</a>(<span class="keywordtype">int</span> log_type, <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="structmsg__struct.html">msg</a>) {
<a name="l00046"></a>00046         <span class="comment">// TODO: ajouter un sémaphore pour ne pas avoir des logs qui déconnent</span>
<a name="l00047"></a>00047         <span class="comment">// on commence par déterminer l'heure à laquelle le log a lieu (en secondes)</span>
<a name="l00048"></a>00048         time_t curTime;
<a name="l00049"></a>00049         time(&amp;curTime);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051         <span class="keywordtype">char</span> tmp[3]= { 0 }, timeStamp[32] = { 0 }, fullMsg[1024] = { 0 };
<a name="l00052"></a>00052         strftime(timeStamp, <span class="keyword">sizeof</span>(timeStamp), <span class="stringliteral">"%Y-%m-%d %H:%M:%S"</span>, localtime(&amp;curTime));
<a name="l00053"></a>00053         <span class="keywordflow">switch</span>(log_type) {
<a name="l00054"></a>00054                 <span class="keywordflow">case</span> <a class="code" href="logger_8h.html#26a2ec2574e71d699a30a6da87a9060aee067308743486de1676fa06a8b42e31">call_type</a>: strcpy(tmp,<span class="stringliteral">"[*]"</span>); <span class="keywordflow">break</span>;
<a name="l00055"></a>00055                 <span class="keywordflow">case</span> <a class="code" href="logger_8h.html#26a2ec2574e71d699a30a6da87a9060a8f02a988f6843d2c18070bd138c4b565">msg_type</a>: strcpy(tmp,<span class="stringliteral">"[M]"</span>); <span class="keywordflow">break</span>; <span class="comment">// 'M' comme Message</span>
<a name="l00056"></a>00056                         <span class="keywordflow">default</span>: strcpy(tmp,<span class="stringliteral">"[U]"</span>); <span class="comment">// 'U' comme Unkown</span>
<a name="l00057"></a>00057                 }
<a name="l00058"></a>00058                 sprintf(fullMsg, <span class="stringliteral">"%s &lt;%s&gt;\t %s"</span>, tmp, timeStamp, msg);
<a name="l00059"></a>00059                 FILE *fp = fopen(<a class="code" href="logger_8c.html#eac90097f29f7529968697163cea5c18">filename</a>, <span class="stringliteral">"a+"</span>); <span class="comment">// ouverture du fichier de log en mode "append" (ajout)</span>
<a name="l00060"></a>00060                 <span class="keywordflow">if</span> (fp == NULL) {
<a name="l00061"></a>00061                         <span class="comment">// ne devrait pas arriver vu la vérif dans init_log, sauf si les permissions changent pendant le </span>
<a name="l00062"></a>00062                         <span class="comment">// déroulement du programme... Pensez à arrêter le programme si init_log() retourne 0.</span>
<a name="l00063"></a>00063                         <span class="comment">// si on ne peut pas logger, alors on affiche erreur puis le message à être loggué dans stderr</span>
<a name="l00064"></a>00064                         fprintf(stderr, <span class="stringliteral">"\n[!!!] Le fichier \"%s\" n'est pas modifiable!"</span>,<a class="code" href="logger_8c.html#eac90097f29f7529968697163cea5c18">filename</a>);
<a name="l00065"></a>00065                         fprintf(stderr, <span class="stringliteral">"\n[!!!] %s\n"</span>, fullMsg);
<a name="l00066"></a>00066                         <span class="keywordflow">return</span>;
<a name="l00067"></a>00067                 }
<a name="l00068"></a>00068                 fprintf(fp, <span class="stringliteral">"%s"</span>, fullMsg);
<a name="l00069"></a>00069                 fwrite(<span class="stringliteral">"\n"</span>, 1, 1, fp);
<a name="l00070"></a>00070                 fflush(fp);
<a name="l00071"></a>00071                 fclose(fp);
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Thu Jan 15 15:40:19 2009 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.5 </small></address>
</body>
</html>
